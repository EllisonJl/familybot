<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯å›¾ç‰‡æ¥æ”¶è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; } .error { color: red; } .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        img { max-width: 300px; margin: 10px 0; border-radius: 5px; }
        .image-info { background: #e7f3ff; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å‰ç«¯å›¾ç‰‡æ¥æ”¶è°ƒè¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>1. æµ‹è¯•AI Agentæ¥å£ç›´æ¥è°ƒç”¨</h3>
        <button onclick="testAIAgentDirect()">ç›´æ¥æµ‹è¯•AI Agent</button>
        <div id="ai-agent-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. æµ‹è¯•å‰ç«¯chatServiceè°ƒç”¨</h3>
        <button onclick="testChatService()">æµ‹è¯•å‰ç«¯Service</button>
        <div id="chat-service-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•</h3>
        <div id="image-display"></div>
    </div>

    <script>
        let latestImageData = null;

        async function testAIAgentDirect() {
            const resultDiv = document.getElementById('ai-agent-result');
            resultDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•AI Agentæ¥å£...</div>';
            
            try {
                const response = await fetch('http://localhost:8001/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'ç”»ä¸€åªå¯çˆ±çš„å°çŒ«å’ª',
                        user_id: 'debug_user',
                        character_id: 'meiyang'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const hasImageUrl = !!(data.image_url);
                    const hasImageBase64 = !!(data.image_base64);
                    const imageUrlLength = data.image_url ? data.image_url.length : 0;
                    const imageBase64Length = data.image_base64 ? data.image_base64.length : 0;
                    
                    latestImageData = data;
                    
                    resultDiv.innerHTML = `
                        <div class="success">âœ… AI Agentæ¥å£è°ƒç”¨æˆåŠŸ</div>
                        <div><strong>å“åº”æ£€æŸ¥:</strong></div>
                        <ul>
                            <li>responseå­˜åœ¨: ${!!data.response}</li>
                            <li>image_urlå­˜åœ¨: ${hasImageUrl} ${hasImageUrl ? `(${imageUrlLength}å­—ç¬¦)` : ''}</li>
                            <li>image_base64å­˜åœ¨: ${hasImageBase64} ${hasImageBase64 ? `(${imageBase64Length}å­—ç¬¦)` : ''}</li>
                            <li>image_description: ${data.image_description || 'æ— '}</li>
                        </ul>
                        <div><strong>è§’è‰²å›åº”:</strong> ${data.response.substring(0, 100)}...</div>
                        ${hasImageUrl ? `<div class="image-info">ğŸ”— å›¾ç‰‡URL: <a href="${data.image_url}" target="_blank">æŸ¥çœ‹å›¾ç‰‡</a></div>` : ''}
                        <button onclick="showImageFromAIAgent()">æ˜¾ç¤ºå›¾ç‰‡</button>
                        <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ AI Agentè¯·æ±‚å¤±è´¥: ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        async function testChatService() {
            const resultDiv = document.getElementById('chat-service-result');
            resultDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•å‰ç«¯ChatService...</div>';
            
            try {
                // æ¨¡æ‹Ÿå‰ç«¯chatServiceçš„è°ƒç”¨é€»è¾‘
                const aiResponse = await fetch('http://localhost:8001/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'debug_user',
                        character_id: 'xiyang',
                        message: 'ç”»ä¸€æœµç¾ä¸½çš„ç«ç‘°èŠ±',
                        force_web_search: false,
                        voice_config: { voice: 'onyx', speed: 1.0 }
                    })
                });
                
                const aiData = await aiResponse.json();
                
                // æ¨¡æ‹Ÿå‰ç«¯çš„å­—æ®µè½¬æ¢é€»è¾‘
                const frontendResponse = {
                    characterId: aiData.character_id,
                    characterName: aiData.character_name,
                    response: aiData.response,
                    emotion: aiData.emotion || 'neutral',
                    timestamp: aiData.timestamp || new Date().toISOString(),
                    audioUrl: aiData.audio_url,
                    audioBase64: aiData.audio_base64,
                    webSearchUsed: aiData.web_search_used || false,
                    webSearchQuery: aiData.web_search_query,
                    webSearchResultsCount: aiData.web_search_results_count || 0,
                    // å›¾ç‰‡å­—æ®µæ˜ å°„
                    imageUrl: aiData.image_url,
                    imageBase64: aiData.image_base64,
                    imageDescription: aiData.image_description,
                    enhancedPrompt: aiData.enhanced_prompt
                };
                
                latestImageData = frontendResponse;
                
                const hasImageUrl = !!(frontendResponse.imageUrl);
                const hasImageBase64 = !!(frontendResponse.imageBase64);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… å‰ç«¯Serviceè°ƒç”¨æˆåŠŸ</div>
                    <div><strong>è½¬æ¢åçš„å­—æ®µæ£€æŸ¥:</strong></div>
                    <ul>
                        <li>imageUrl: ${hasImageUrl}</li>
                        <li>imageBase64: ${hasImageBase64}</li>
                        <li>imageDescription: ${frontendResponse.imageDescription || 'æ— '}</li>
                        <li>enhancedPrompt: ${!!frontendResponse.enhancedPrompt}</li>
                    </ul>
                    <div><strong>è§’è‰²å›åº”:</strong> ${frontendResponse.response.substring(0, 100)}...</div>
                    ${hasImageUrl ? `<div class="image-info">ğŸ”— è½¬æ¢åçš„å›¾ç‰‡URLå­˜åœ¨ï¼Œé•¿åº¦: ${frontendResponse.imageUrl.length}</div>` : ''}
                    <button onclick="showImageFromFrontend()">æ˜¾ç¤ºè½¬æ¢åçš„å›¾ç‰‡</button>
                    <pre>${JSON.stringify(frontendResponse, null, 2).substring(0, 600)}...</pre>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ChatServiceæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        function showImageFromAIAgent() {
            if (!latestImageData || !latestImageData.image_url) {
                alert('æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯æ˜¾ç¤º');
                return;
            }
            showImage(latestImageData.image_url, latestImageData.image_description, 'æ¥è‡ªAI Agent');
        }

        function showImageFromFrontend() {
            if (!latestImageData || !latestImageData.imageUrl) {
                alert('æ²¡æœ‰å‰ç«¯å›¾ç‰‡æ•°æ®å¯æ˜¾ç¤º');
                return;
            }
            showImage(latestImageData.imageUrl, latestImageData.imageDescription, 'æ¥è‡ªå‰ç«¯è½¬æ¢');
        }

        function showImage(imageUrl, description, source) {
            const displayDiv = document.getElementById('image-display');
            displayDiv.innerHTML = `
                <h4>ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯• (${source})</h4>
                <div class="image-info">
                    <div><strong>æè¿°:</strong> ${description || 'æ— æè¿°'}</div>
                    <div><strong>URL:</strong> <a href="${imageUrl}" target="_blank">${imageUrl.substring(0, 50)}...</a></div>
                </div>
                <img src="${imageUrl}" alt="${description || 'ç”Ÿæˆçš„å›¾ç‰‡'}" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥', this.src)">
                <div><small>å¦‚æœå›¾ç‰‡ä¸æ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯æˆ–ç‚¹å‡»URLé“¾æ¥åœ¨æ–°çª—å£æŸ¥çœ‹</small></div>
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            console.log('ğŸ”§ è°ƒè¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>
